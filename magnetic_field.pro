function P10,Hreturn,COS(H)endfunction P11,Hreturn,SIN(H)endfunction P20,Hreturn,((3.d0*COS(2.d0*H)+1.d0)/4.d0)endfunction P21,H return,(sqrt(3.d0) / 2.d0 * SIN(2.d0 * H))endfunction P22,H return,(sqrt(3.d0) / 4.d0 * (1.d0 - COS(2.d0 * H)))endfunction P30,H return,(5.d0*COS(3.d0*H)+3.d0*COS(H))/8.d0endfunction P31,H return,sqrt(3.d0) / 8.d0 / sqrt(2.d0) * (5.d0 * SIN(3.d0 * H) + SIN(H))endfunction P32,H return,(sqrt(15.d0) / 8.d0 * (COS(H) - COS(3.d0 * H)))endfunction P33,H return,(sqrt(5.d0) / 8.d0 / sqrt(2.d0) * (3.d0 * SIN(H) - SIN(3.d0 * H)))endfunction P40,H return,((35.d0 * COS(4.d0 * H) + 20.d0 * COS(2.d0 * H) + 9.d0) / 64.d0)endfunction P41,H return,(sqrt(5.d0) / 16.d0 / sqrt(2.d0) * (7.d0 * SIN(4.d0 * H) + 2.d0 * SIN(2.d0 * H)))endfunction P42,Hreturn,(sqrt(5.d0)/32.d0*(3.d0+4.d0*COS(2.d0*H)-7.d0*COS(4.d0*H)))endfunction P43,H return,(sqrt(35.d0) / 16.d0 / sqrt(2.d0) * (2.d0 * SIN(2 * H) - SIN (4 * H)))endfunction P44,H return,(sqrt(35.d0) / 64.d0 * (COS(4.d0 * H) - 4.d0 * COS(2.d0 * H) + 3.d0))endfunction DP10,H return,-SIN(H)endfunction DP11,Hreturn,COS(H)endfunction DP20,H return,(-3.d0 / 2.d0 * SIN(2.d0 * H))endfunction DP21,H return,(sqrt(3.d0) * COS(2.d0  * H))endfunction DP22,H return,(sqrt(3.d0) / 2.d0 * SIN(2.d0  * H))endfunction DP30,H return,(-3.d0 / 8.d0 * (5.d0 * SIN(3.d0 * H) + SIN(H)))endfunction DP31,H return,(sqrt(3.d0) / 8.d0 / sqrt(2.d0 ) * (15.d0 * COS(3.d0 * H) + COS(H)))endfunction DP32,H return,(sqrt(15.d0) / 8.d0 * (3.d0 * SIN(3.d0 * H) - SIN(H)))endfunction DP33,H return,(3.d0 * sqrt(5.d0) / 8.d0 / sqrt(2.d0 ) * (COS(H) - COS(3.d0 * H)))endfunction DP40,H return,(-5.d0 / 16.d0 * (7.d0 * SIN(4.d0 * H) + 2.d0 * SIN(2.d0  * H)))endfunction DP41,H return,(sqrt(5.d0) / 4.d0 / sqrt(2.d0 ) * (7.d0 * COS(4.d0 * H)+COS(2.d0*H)))endfunction DP42,H return,(sqrt(5.d0)/8.d0*(7.d0*SIN(4.d0*H)-2.d0*SIN(2.d0*H)))endfunction DP43,H return,(sqrt(35.d0)/4.d0/sqrt(2.d0)*(COS(2.d0*H)-COS(4.d0*H)))endfunction DP44,H return,(sqrt(35.d0)/16.d0*(2.d0*SIN(2.d0*H)-SIN(4.d0*H)))endpro MAGNETIC_FIELD,RTP, B_SPH,B,br,mfl_model=mfl_model,nocrt=nocrtnelmt=n_elements(rtp(0,*))b_sph=dblarr(3,nelmt)r=rtp(0,*)rtheta=rtp(1,*);theta*!dpi/180.d0rphi=rtp(2,*);phi*!dpi/180.d0COEFF,g,h,n,dip,crt,tdip,mfl_model=mfl_model;c=cos((dindgen(5)+1.)*rphi);s=sin((dindgen(5)+1.)*rphi)c=rebin(reform(rphi,1,nelmt),5,nelmt) & for i=0,4 do c(i,*)=c(i,*)*(double(i)+1.)s=sin(c) & c=cos(c)   b_sph(0,*)=2.d0*1./r^3*(P10(rtheta)*G(1,0)$			+P11(rtheta)*(G(1,1)*c(0,*)+H(1,1)*s(0,*)))$	    + 3*1./r^4*(P20(rtheta)*G(2,0)$			+P21(rtheta)*(G(2,1)*c(0,*)+H(2,1)*s(0,*))$			+P22(rtheta)*(G(2,2)*c(1,*)+H(2,2)*s(1,*)))$	    + 4*1./r^5*(P30(rtheta)*G(3,0)$			+P31(rtheta)*(G(3,1)*c(0,*)+H(3,1)*s(0,*))$			+P32(rtheta)*(G(3,2)*c(1,*)+H(3,2)*s(1,*))$			+P33(rtheta)*(G(3,3)*c(2,*)+H(3,3)*s(2,*)))$	    + 5*1./r^6*(P40(rtheta)*G(4,0)$			+P41(rtheta)*(G(4,1)*c(0,*)+H(4,1)*s(0,*))$			+P42(rtheta)*(G(4,2)*c(1,*)+H(4,2)*s(1,*))$			+P43(rtheta)*(G(4,3)*c(2,*)+H(4,3)*s(2,*))$			+P44(rtheta)*(G(4,4)*c(3,*)+H(4,4)*s(3,*)))   b_sph(1,*) = - 1./r^3*(DP10(rtheta)*G(1,0)$			+DP11(rtheta)*(G(1,1)*c(0,*)+H(1,1)*s(0,*)))$	    - 1./r^4*(DP20(rtheta)*G(2,0)$			+DP21(rtheta)*(G(2,1)*c(0,*)+H(2,1)*s(0,*))$			+DP22(rtheta)*(G(2,2)*c(1,*)+H(2,2)*s(1,*)))$	    - 1./r^5*(DP30(rtheta)*G(3,0)$			+ DP31(rtheta)*(G(3,1)*c(0,*)+H(3,1)*s(0,*))$			+DP32(rtheta)*(G(3,2)*c(1,*)+H(3,2)*s(1,*))$			+DP33(rtheta)*(G(3,3)*c(2,*)+H(3,3)*s(2,*)))$	    - 1./r^6*(DP40(rtheta)*G(4,0)$			+DP41(rtheta)*(G(4,1)*c(0,*)+H(4,1)*s(0,*))$			+DP42(rtheta)*(G(4,2)*c(1,*)+H(4,2)*s(1,*))$			+DP43(rtheta)*(G(4,3)*c(2,*)+H(4,3)*s(2,*))$			+DP44(rtheta)*(G(4,4)*c(3,*)+H(4,4)*s(3,*)))   b_sph(2,*) =(1./r^3*($	         P11(rtheta)*(G(1,1)*s(0,*)-H(1,1)*c(0,*)))$	    +1./r^4*($	        P21(rtheta)*(G(2,1)*s(0,*)-H(2,1)*c(0,*))$	     +2*P22(rtheta)*(G(2,2)*s(1,*)-H(2,2)*c(1,*)))$	    +1./r^5 *($	         P31(rtheta)*(G(3,1)*s(0,*)-H(3,1)*c(0,*))$	     +2*P32(rtheta)*(G(3,2)*s(1,*)-H(3,2)*c(1,*))$	     +3*P33(rtheta)*(G(3,3)*s(2,*)-H(3,3)*c(2,*)))$	    +1./r^6*($	         P41(rtheta)*(G(4,1)*s(0,*)-H(4,1)*c(0,*))$	     +2*P42(rtheta)*(G(4,2)*s(1,*)-H(4,2)*c(1,*))$	     +3*P43(rtheta)*(G(4,3)*s(2,*)-H(4,3)*c(2,*))$	     +4*P44(rtheta)*(G(4,4)*s(3,*)-H(4,4)*c(3,*))))/sin(rtheta)if not(keyword_set(nocrt)) then CRT_SHEET,r,theta,phi,crt,tdip,br else br=0.b_sph=b_sph+br*1.e-5b=sqrt(total(b_sph^2.,1))returnend